sequenceDiagram
    %% ==========================================
    %% DIAGRAMA DE SEQUÊNCIA - Cálculo e Exibição do Ranking
    %% Principal funcionalidade do sistema Tô De Olho
    %% ==========================================

    autonumber

    participant U as Usuario<br/>(Navegador)
    participant F as Frontend<br/>(Next.js)
    participant A as API REST<br/>(Gin)
    participant R as RankingService
    participant C as Cache<br/>(Redis)
    participant DB as PostgreSQL

    %% Requisição inicial do usuário
    U->>+F: Acessar /ranking
    F->>+A: GET /api/v1/ranking?ano=2025

    %% Verificar cache primeiro
    A->>+R: CalcularRanking(ano)
    R->>+C: GET ranking:2025
    
    alt Cache válido (TTL não expirado)
        C-->>R: Ranking cacheado
        R-->>A: []SenadorScore
    else Cache inválido ou expirado
        C-->>-R: null
        
        %% Buscar dados do banco
        par Buscar dados em paralelo
            R->>+DB: SELECT FROM proposicoes<br/>GROUP BY senador_id
            DB-->>-R: Estatísticas proposições
        and
            R->>+DB: SELECT FROM votacoes<br/>GROUP BY senador_id
            DB-->>-R: Estatísticas votações
        and
            R->>+DB: SELECT SUM(valor) FROM despesas_ceaps<br/>GROUP BY senador_id
            DB-->>-R: Totais CEAPS
        and
            R->>+DB: SELECT FROM comissao_membros<br/>GROUP BY senador_id
            DB-->>-R: Participações comissões
        end

        %% Processar e calcular scores
        R->>R: calcularProdutividade()
        R->>R: calcularPresenca()
        R->>R: calcularEconomiaCEAPS()
        R->>R: calcularComissoes()
        R->>R: normalizarScores(0-100)
        R->>R: aplicarPesos()
        R->>R: ordenarPorScoreFinal()
        R->>R: atribuirPosicoes()
        
        %% Salvar no cache
        R->>+C: SET ranking:2025 (TTL: 1h)
        C-->>-R: OK
        
        R-->>A: []SenadorScore
    end

    A-->>-F: JSON Response
    
    %% Renderizar no frontend
    F->>F: Renderizar tabela<br/>do ranking
    F->>F: Renderizar gráficos<br/>radar (Recharts)
    F-->>-U: Página do Ranking

    %% Interação adicional do usuário
    U->>+F: Clicar em senador
    F->>+A: GET /api/v1/senadores/{id}/score
    A->>+R: GetScoreIndividual(id)
    R->>+C: GET ranking:2025
    C-->>-R: Ranking completo
    R->>R: Filtrar por senador_id
    R-->>-A: SenadorScore
    A-->>-F: JSON Response
    F-->>-U: Modal com detalhes
